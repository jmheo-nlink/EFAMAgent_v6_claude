#region 변경 이력
/*
 * Author : Link mskoo (2011. 4. 18)
 * 
 * ====================================================================================================================
 * Date         Name            Description of Change
 * --------------------------------------------------------------------------------------------------------------------
 * 2011-04-18   mskoo           최초 작성.
 * 
 * 2011-09-23   mskoo           5.0 버전 릴리즈. (변경 이력 정리)
 * 
 * 2012-02-11   mskoo           폼의 크기를 변경할 수 있도록 수정.
 * 
 * 2012-02-11   mskoo           도메인에 가입된 컴퓨터이면 일반 설정 항목들을 설정할 수 없도록 수정.
 *                              - ApplyAndSaveChangedSettings()
 *                              - ConfigDialog_Load(object, EventArgs)
 *                              
 * 2012-02-12   mskoo           네트워크 드라이브의 사용 여부를 설정할 수 있도록 수정.
 *                              - ApplyAndSaveChangedSettings()
 *                              - ConfigDialog_Load(object, EventArgs)
 *                              - grdNetwkDriveList_CellBeginEdit(object, DataGridViewCellCancelEventArgs)
 *                              - grdNetwkDriveList_CellEndEdit(object, DataGridViewCellEventArgs)
 *                              
 * 2012-02-26   mskoo           응용 프로그램 설정을 래핑한 AgentSettings 클래스를 사용하여 설정 속성을 액세스하도록 수정.
 *                              - ApplyAndSaveChangedSettings()
 *                              - ConfigDialog_Load(object, EventArgs)
 *                              
 * 2012-01-27   mskoo           SoftCamp S-Work와 연동하기 위한 코드를 추가.
 *                              - ConfigDialog()
 *                              - ApplyAndSaveChangedSettings()
 *                              - ConfigDialog_Load(object, EventArgs)
 *                              
 * 2013-05-14   mskoo           속성 추가.
 *                              - StartupTabIndex
 *                              
 * 2013-11-16   jake            드라이브의 볼륨 레이블을 추가.
 *                              - SetLocalizedText()
 *                              - ConfigDialog_Load(object, EventArgs)
 * ====================================================================================================================
 */
#endregion

using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
// "Krypton Toolkit" 라이브러리
using ComponentFactory.Krypton.Toolkit;
// .NET용 개발 라이브러리
//using Link.DLK.Net;
using Link.DLK.Win32;

namespace Link.EFAM.Agent.UI
{
    using Link.EFAM.Core;
    using Link.EFAM.Agent.Properties;
    using Link.EFAM.Agent.Configuration;

    using CaseInsensitiveStringCollection = Link.DLK.Collections.StringCollection;

    public partial class ConfigDialog : KryptonForm
    {
        private enum ColumnIndex
        {
            UseDrive = 0,
            DriveName,
            VolumeLabel,
            SharedFolder,
        }

        private Panel m_settingPanel = null;
        private bool m_useGeneralSetting = true;
        private int m_startupTabIndex = 0;

        #region 생성자

        /// <summary>
        /// <see cref="ConfigDialog"/> 클래스의 새 인스턴스를 초기화한다.
        /// </summary>
        public ConfigDialog()
        {
            InitializeComponent();
            SetLocalizedText();

            this.Height = 320;
            pnlGeneralSetting.Dock = DockStyle.Fill;
            tlpnlDriveSetting.Dock = DockStyle.Fill;
            pnlConnSetting.Dock = DockStyle.Fill;

#if INTEROP_SWORK   // ============================================================================
            m_useGeneralSetting = false;
#else   // ========================================================================================
            m_useGeneralSetting = !AgentStore.Store.IsInSameDomainWithNAS;
#endif  // INTEROP_SWORK ==========================================================================
        }

        #endregion

        #region 속성

        /// <summary>
        /// 환경 설정 대화상자를 표시할 때 선택된 탭으로 지정할 인덱스를 가져오거나 설정한다.
        /// </summary>
        /// <value>선택된 탭으로 지정할 인덱스 값</value>
        public int StartupTabIndex
        {
            get { return m_startupTabIndex; }
            set 
            {
                m_startupTabIndex = (value < 0) ? 0 : ((value > 2) ? 2 : value);
            }
        }

        #endregion

        #region 메소드

        /// <summary>
        /// 각 컨트롤에 지역화된 텍스트를 설정한다.
        /// </summary>
        private void SetLocalizedText()
        {
            //
            // 폼
            //
            this.Text = Resources.ConfigDialog_Text;
            btnOK.Text = Resources.Button_OK;
            btnCancel.Text = Resources.Button_Cancel;
            //
            // 일반 설정
            //
            btnGeneralSetting.Text = Resources.Config_GeneralSetting;
            lblRunSetting.Text = Resources.Label_RunSetting;
            chkAutoRun.Text = Resources.Check_AutoRunSetting;
            chkAutoLogin.Text = Resources.Check_AutoLoginSetting;
            //
            // 드라이브 설정
            //
            btnDriveSetting.Text = Resources.Config_DriveSetting;
            lblNetwkDriveSetting.Text = Resources.Label_NetworkDriveSetting;
            lblNdsMessage.Text =
                String.Format(Resources.Info_ApplySettingOnRelogin, lblNetwkDriveSetting.Text);
            columnUse.HeaderText = Resources.Column_UseDrive;
            columnDriveName.HeaderText = Resources.Column_DriveName;
            columnVolumeLabel.HeaderText = Resources.Column_VolumeLabel;
            columnSharedFolder.HeaderText = Resources.Column_SharedFolder;
            //
            // 연결 설정
            //
            btnConnSetting.Text = Resources.Config_ConnectionSetting;
            lblServerConnSetting.Text = Resources.Label_ServerConnSetting;
            lblScsMessage.Text =
                String.Format(Resources.Info_ApplySettingOnRelogin, lblServerConnSetting.Text);
            lblScsDesc.Text = Resources.Desc_ServerConnSetting;
            lblServerAddr.Text = Resources.Label_ServerAddress;
        }

        /// <summary>
        /// 값이 변경된 설정 항목들을 적용하고, 응용 프로그램 설정에 저장한다.
        /// </summary>
        private void ApplyAndSaveChangedSettings()
        {
            AgentStore store = AgentStore.Store;
            AgentSettings appSettings = AgentSettings.Default;
            bool changed = false;

            if (store.IsAuthenticated)
            {
                //
                // 일반 설정
                //
                if (m_useGeneralSetting)
                {
                    if (chkAutoRun.Checked != appSettings.AutoRun)
                    {
                        ConfigHelper.ApplyAutoRunSetting(chkAutoRun.Checked);
                        changed = true;
                    }
                    if (chkAutoLogin.Checked != appSettings.AutoLogin)
                    {
                        ConfigHelper.ApplyAutoLoginSetting(
                            chkAutoLogin.Checked, store.InputedUserId, store.InputedPassword);
                        changed = true;
                    }
                } // if (m_useGeneralSetting)
                //
                // 드라이브 설정
                //
                if ((bool)grdNetwkDriveList.Tag)
                {
                    List<NetworkDriveSetting> settingList 
                        = new List<NetworkDriveSetting>(grdNetwkDriveList.RowCount);
                    NetworkDriveSetting netwkdrvSetting = null;

                    foreach (DataGridViewRow row in grdNetwkDriveList.Rows)
                    {
                        netwkdrvSetting = new NetworkDriveSetting();
                        netwkdrvSetting.UseDrive = (bool)row.Cells[(int)ColumnIndex.UseDrive].Value;
                        netwkdrvSetting.DriveName = (string)row.Cells[(int)ColumnIndex.DriveName].Value;
                        netwkdrvSetting.SharedFolder 
                            = (string)row.Cells[(int)ColumnIndex.SharedFolder].Value;

                        settingList.Add(netwkdrvSetting);
                    } // foreach ( DataGridViewRow )

                    appSettings.NetworkDriveSettings = settingList;
                    changed = true;
                } // if ((bool)grdNetwkDriveList.Tag)
            } // if (store.IsAuthenticated)
            //
            // 연결 설정
            //
            if (txtServerUrl.Text != appSettings.ServerUrl)
            {
                appSettings.ServerUrl = txtServerUrl.Text.Trim();
                changed = true;
            }

            // 설정값들을 저장한다.
            if (changed) appSettings.Save();
        }

        #endregion

        #region 이벤트 핸들러

        /// <summary>
        /// 폼을 로드할 때 필요한 작업을 진행한다.
        /// </summary>
        private void ConfigDialog_Load(object sender, EventArgs e)
        {
            if (m_useGeneralSetting)
            {
                m_settingPanel = pnlGeneralSetting;
            }
            else
            {
                btnGeneralSetting.Visible = false;
                pnlGeneralSetting.Visible = false;
                tlpnlDriveSetting.Visible = true;

                m_settingPanel = tlpnlDriveSetting;
            }

            ///////////////////////////////////////////////////////////////////////////////////////
            // 응용 프로그램 설정에 저장된 환경 설정값들을 표시한다.
            //
            AgentSettings appSettings = AgentSettings.Default;

            if (AgentStore.Store.IsAuthenticated)
            {
                //
                // 일반 설정
                //
                chkAutoRun.Checked = appSettings.AutoRun;
                chkAutoLogin.Checked = appSettings.AutoLogin;
                //
                // 드라이브 설정
                //
                DataGridViewRowCollection gridRowColl = grdNetwkDriveList.Rows;
                NetworkDriveSettingSet settingSet 
                    = new NetworkDriveSettingSet(appSettings.NetworkDriveSettings);
                NetworkDriveSetting netwkdrvSetting = null;
                string driveName = null;
                bool useDrive = true;
                int rowIndex = 0;

                foreach (SharedDrive drive in AgentStore.Store.SharedDrives)
                {
                    if (drive.DriveName.Length == 0) continue;

                    netwkdrvSetting = settingSet[drive.ShareName];
#if (INTEROP_SWORK || INTEROP_SWORK_HHISB)  // ====================================================
                    useDrive = (drive.IsSecure || netwkdrvSetting == null) ? true : netwkdrvSetting.UseDrive;
#else   // ========================================================================================
                    useDrive = (netwkdrvSetting == null) ? true : netwkdrvSetting.UseDrive;
#endif  // INTEROP_SWORK || INTEROP_SWORK_HHISB ===================================================
                    driveName = (netwkdrvSetting != null)
                                ? netwkdrvSetting.DriveName : drive.DriveName;
                    if (driveName == "*") driveName = "";

                    rowIndex = gridRowColl.Add(useDrive, driveName, drive.VolumeLabel, drive.ShareName);

                    gridRowColl[rowIndex].Cells[(int)ColumnIndex.UseDrive].Tag = useDrive;
                    // 사용중인 드라이브 이름을 설정한다.
                    gridRowColl[rowIndex].Cells[(int)ColumnIndex.DriveName].Tag 
                        = drive.IsConnected ? drive.DriveName : null;
#if (INTEROP_SWORK || INTEROP_SWORK_HHISB)  // ====================================================
                    if (drive.IsSecure)
                    {
                        gridRowColl[rowIndex].Cells[(int)ColumnIndex.UseDrive].ReadOnly = true;
                        gridRowColl[rowIndex].Cells[(int)ColumnIndex.UseDrive].ToolTipText 
                            = Resources.ToolTip_CannotChangeUse;
                        gridRowColl[rowIndex].Cells[(int)ColumnIndex.SharedFolder].Style.ForeColor = Color.Red;
                    }
                    else
                    {
                        gridRowColl[rowIndex].Cells[(int)ColumnIndex.SharedFolder].Style.ForeColor = Color.Black;
                    }
#endif  // INTEROP_SWORK || INTEROP_SWORK_HHISB ===================================================
                } // foreach ( SharedDrive )

                //if (m_useGeneralSetting) btnGeneralSetting.PerformClick();
                //else btnDriveSetting.PerformClick();
                if (!m_useGeneralSetting && m_startupTabIndex == 0) m_startupTabIndex = 1;

                if (m_startupTabIndex == 0) btnGeneralSetting.PerformClick();
                else if (m_startupTabIndex == 1) btnDriveSetting.PerformClick();
                else if (m_startupTabIndex == 2) btnConnSetting.PerformClick();
            } // if (AgentStore.Store.IsAuthenticated)
            else
            {
                //
                // 일반 설정
                //
                chkAutoRun.Enabled = false;
                chkAutoLogin.Enabled = false;
                //
                // 드라이브 설정
                //
                grdNetwkDriveList.Enabled = false;

                btnConnSetting.PerformClick();
            } // else
            //
            // 연결 설정
            //
            txtServerUrl.Text = appSettings.ServerUrl;

            grdNetwkDriveList.Tag = false;
            lblNdsMessage.Visible = false;
            lblScsMessage.Visible = false;
        }

        #region 버튼 이벤트

        /// <summary>
        /// "OK" 버튼을 클릭할 때 필요한 작업을 진행한다.
        /// </summary>
        private void btnOK_Click(object sender, EventArgs e)
        {
            ApplyAndSaveChangedSettings();

            this.Close();
        }

        /// <summary>
        /// 설정 항목 버튼을 클릭할 때 필요한 작업을 진행한다.
        /// </summary>
        private void btnSettingItem_Click(object sender, EventArgs e)
        {
            Panel newDisplayPanel = null;

            if (sender == btnGeneralSetting) newDisplayPanel = pnlGeneralSetting;
            else if (sender == btnDriveSetting) newDisplayPanel = tlpnlDriveSetting;
            else if (sender == btnConnSetting) newDisplayPanel = pnlConnSetting;

            if (m_settingPanel != newDisplayPanel)
            {
                newDisplayPanel.Visible = true;
                m_settingPanel.Visible = false;
                m_settingPanel = newDisplayPanel;
            }
        }

        #endregion

        /// <summary>
        /// 선택한 셀에 대한 편집 모드가 시작될 때 필요한 작업을 진행한다.
        /// </summary>
        private void grdNetwkDriveList_CellBeginEdit(object sender, DataGridViewCellCancelEventArgs e)
        {
            DataGridViewRowCollection gridRowColl = grdNetwkDriveList.Rows;

            // 드라이브 이름 컬럼일 경우
            if (e.ColumnIndex == (int)ColumnIndex.DriveName)
            {
                bool useDrive = (bool)gridRowColl[e.RowIndex].Cells[(int)ColumnIndex.UseDrive].Value;

                if (!useDrive)
                {
                    e.Cancel = true;
                    return;
                }
            } // if (e.ColumnIndex == DriveNameColumnIndex)
            else return;

            ///////////////////////////////////////////////////////////////////////////////////////
            // 선택한 셀에 표시되는 콤보 박스 컨트롤에 사용할 수 있는 드라이브 이름 목록을 설정한다.
            //
            DataGridViewCell driveNameCell = gridRowColl[e.RowIndex].Cells[(int)ColumnIndex.DriveName];
            CaseInsensitiveStringCollection usableDriveNameColl = WindowsUtility.GetUsableDriveNames();

            if (driveNameCell.Tag != null)
            {
                usableDriveNameColl.Add((string)driveNameCell.Value);
                usableDriveNameColl.Add((string)driveNameCell.Tag);
            }

            //
            // 다른 네트워크 드라이브에서 사용 중인 드라이브 이름은 제거한다.
            //
            string driveName = null;
            string usingDriveName = null;

            foreach (DataGridViewRow row in gridRowColl)
            {
                if (row.Index == e.RowIndex) continue;

                driveNameCell = row.Cells[(int)ColumnIndex.DriveName];
                driveName = (string)driveNameCell.Value;
                usingDriveName = (string)driveNameCell.Tag;

                if ((bool)row.Cells[(int)ColumnIndex.UseDrive].Value)
                {
                    usableDriveNameColl.Remove(driveName);

                    if (usingDriveName != null && usingDriveName != driveName)
                    {
                        usableDriveNameColl.Add(usingDriveName);
                    }
                } // if ((bool)row.Cells[UseDriveColumnIndex].Value)
                else if (usingDriveName != null)
                {
                    usableDriveNameColl.Add(usingDriveName);
                }
            } // foreach ( DataGridViewRow )

            //
            // 드라이브 이름 목록을 설정한다.
            //
            List<string> list = new List<string>(usableDriveNameColl);

            list.Sort();
            list.Reverse();

            columnDriveName.Items.Clear();
            columnDriveName.Items.AddRange(list.ToArray());
        }

        /// <summary>
        /// 현재 선택한 셀에 대한 편집 모드가 중지될 때 필요한 작업을 진행한다.
        /// </summary>
        private void grdNetwkDriveList_CellEndEdit(object sender, DataGridViewCellEventArgs e)
        {
            DataGridViewCell cell = grdNetwkDriveList.Rows[e.RowIndex].Cells[e.ColumnIndex];
            bool changed = false;

            if (e.ColumnIndex == (int)ColumnIndex.UseDrive)
            {
                changed = (bool)cell.Value != (bool)cell.Tag;
            }
            else if (e.ColumnIndex == (int)ColumnIndex.DriveName)
            {
                changed = (string)cell.Value != (string)cell.Tag;
            }

            if (changed)
            {
                grdNetwkDriveList.Tag = true;
                lblNdsMessage.Visible = true;
            }
        }

        /// <summary>
        /// Text 속성 값이 컨트롤에서 변경되면 필요한 작업을 진행한다.
        /// </summary>
        private void txtServerUrl_TextChanged(object sender, EventArgs e)
        {
            if (AgentStore.Store.IsAuthenticated) lblScsMessage.Visible = true;
        }

        #endregion 이벤트 핸들러
    }
}
